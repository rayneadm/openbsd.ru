<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
<HEAD>
  <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=koi8-r">
  <META HTTP-EQUIV="Content-Language" CONTENT="ru">
  <META NAME="copyright" CONTENT="Copyright (c) 2006-2008 by OpenBSD.ru">
  <TITLE>Сборка custom ядра</TITLE>
  <link rel="stylesheet" type="text/css" href="style.css" tppabs="http://www.openbsd.ru/style.css" />
</HEAD>
<BODY>

<H2>Сборка custom ядра</H2>
<HR>

<P>
<STRONG>Содержание</STRONG>:<BR>

<UL>
  <LI><A HREF="#intro">Зачем это нужно?</A>
  <LI><A HREF="#required">Основные опции (на примере архитектуры i386)</A>
  <LI><A HREF="#mp">Поддержка многопроцессорности для архитектуры i386</A>
  <LI><A HREF="#arch">Поддержка расширенных возможностей архитектуры i386</A>
  <LI><A HREF="#debug">Опции, используемые при отладке</A>
  <LI><A HREF="#diag">Статистика и диагностика</A>
  <LI><A HREF="#ip">Стеки протоколов IPv4 и IPv6</A>
  <LI><A HREF="#crypto">Криптография в ядре. Использование криптографии в
   сетевых протоколах</A>
  <LI><A HREF="#filesystem">Файловые системы</A>
  <LI><A HREF="#compat">Совместимость с ранними версиями</A>
  <LI><A HREF="#emul">Двоичная совместимость с другими системами</A>
  <LI><A HREF="#xwindow">X Window System</A>
</UL>

<HR>

<A NAME="intro"></A>
<H3>Зачем это нужно?</H3>

<P>
Причин для сборки custom ядра может быть много, но основные это:

<UL>
  <LI>оптимизация по размеру;
  <LI>оптимизация по скорости;
  <LI>связанные с драйверами устройств (добавление, удаление или изменение
   режима работы).
</UL>

<P>
<STRONG>Внимание:</STRONG> настройка custom ядра - это операция, предполагающая
определенный уровень понимания своих действий и способная привести систему
в нерабочее состояние. Данное руководство призвано прояснить некоторые детали
и помочь в настройке ядра подготовленным пользователям.

<P>
Основная идея оптимизации ядра по размеру - удаление неиспользуемого кода.
Это, прежде всего, неиспользуемые драйверы устройств и различные подсистемы.
Для поиска используемых драйверов устройств можно использовать вывод
<A HREF="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=dmesg&sektion=8  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=dmesg&sektion=8'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=dmesg&sektion=8">dmesg(8)</A>,
а также специализированные программы, например,
<A HREF="javascript:if(confirm('http://www.sentia.org/projects/dmassage/  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.sentia.org/projects/dmassage/'" tppabs="http://www.sentia.org/projects/dmassage/">dmassage</A>.

<P>
Неиспользуемые подсистемы ядра отключаются удалением соответствующих
<EM>опций</EM>, например, если не используется двоичная совместимость с
исполняемыми файлами Linux, можно удалить опцию <CODE><B>COMPAT_LINUX</B></CODE>
и т. д. Список всех опций приведен в руководстве
<A HREF="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=options&sektion=4  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=options&sektion=4'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=options&sektion=4">options(4)</A>.

<A NAME="required"></A>
<H3><FONT COLOR="#0000e0">Основные опции (на примере архитектуры i386)</FONT></H3>

Ниже приведен список <EM>опций</EM>, без которых работа ОС будет осложнена
или невозможна:

<P>
<TABLE class="list" WIDTH="100%" CELLPADDING="10" CELLSPACING="0">
<TR VALIGN="top">
<TD>
  <CODE><B>KVM86</B></CODE>
</TD>
<TD>
  Поддержка эмуляции виртуального режима 8086-совместимого процессора.
  Требуется для устройства
  <A HREF="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=piixpcib&sektion=4&arch=i386  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=piixpcib&sektion=4&arch=i386'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=piixpcib&sektion=4&arch=i386">piixpcib(4)</A>. Возможно будет также использоваться для
  разработки бэкенда для драйвера wsfb(4).
</TD>
</TR>
<TR VALIGN="top">
<TD>
<CODE><B>FIFO</B></CODE>
</TD>
<TD>
  Поддержка именованных каналов,
  <A HREF="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=mkfifo&sektion=2  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=mkfifo&sektion=2'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=mkfifo&sektion=2">mkfifo(2)</A>.
</TD>
</TR>
<TR VALIGN="top">
<TD>
  <CODE><B>SYSVMSG</B></CODE><BR>
  <CODE><B>SYSVSEM</B></CODE><BR>
  <CODE><B>SYSVSHM</B></CODE>
</TD>
<TD>
  Средства IPC из UNIX SystemV (очереди сообщений, семафоры, разделяемая память).
</TD>
</TR>
<TR VALIGN="top">
<TD>
  <CODE><B>FFS,FFS2</B></CODE>
</TD>
<TD>
  Файловая система Berkeley Fast File System с поддержкой 2-ой версии.
</TD>
</TR>
<TR VALIGN="top">
<TD>
  <CODE><B>INET</B></CODE>
</TD>
<TD>
  Поддержка протоколов стека IPv4.
</TD>
</TR>
<TR VALIGN="top">
<TD>
  <CODE><B>WSDISPLAY_COMPAT_USL</B></CODE><BR>
  <CODE><B>WSDISPLAY_DEFAULTSCREENS</B></CODE>
</TD>
<TD>
  Поддержка виртуальных экранов.
</TD>
</TR>
</TABLE>

<P>
Остальные опции ядра включаются, если необходим соответствующий функционал.

<A NAME="mp"></A>
<H3>Поддержка многопроцессорности для архитектуры i386</H3>

<P>
Для того чтобы собрать ядро с поддержкой SMP для архитектуры i386, необходимо
добавить в конфигурацию ядра опцию <CODE><B>MULTIPROCESSOR</B></CODE>,
поддержку
<A HREF="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=ioapic&sektion=4&arch=i386  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=ioapic&sektion=4&arch=i386'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=ioapic&sektion=4&arch=i386">I/O APIC</A>
и устройств для дополнительных процессоров:

<PRE>
<STRONG>
option		MULTIPROCESSOR

cpu*		at mainbus?
ioapic*		at mainbus?
</STRONG>
</PRE>

<A NAME="arch"></A>
<H3>Поддержка расширенных возможностей архитектуры i386</H3>

<P>
За долгое время развития архитектура i386 процессора вобрала в себя множество
различных возможностей. Некоторые фундаментальны, некоторые опциональны. Ряд
опциональных возможностей архитектуры i386 в OpenBSD представлен отдельными
опциями или устройствами.

<P>
<TABLE class="list" WIDTH="100%" CELLPADDING="10" CELLSPACING="0">
<TR VALIGN="top">
<TD WIDTH="20%">
  <CODE><B>USER_LDT</B></CODE>
</TD>
<TD>
Добавляет возможность процессам менять локальную таблицу дескрипторов (LDT).
Обычно ядро OpenBSD полагается на глобальную таблицу дескрипторов (GDT) и
отдельные процессы не могут менять LDT. Однако, в ряде случаев, необходимо
иметь возможность изменять её. Чаще всего это связано с работой файлов и
библиотек других систем, например использование эмулятора Wine или Win32
кодеков в mplayer. Возможность изменения LDT должна быть явно задана
sysctl-флагом <CODE><I>machdep.userldt</I></CODE>.
</TD>
</TR>
</TABLE>

<P>
Также поддерживаются два псевдо-устройства, связанные с дополнительными
возможностями процессоров семейства i386. Прежде всего это поддержка
регистров атрибутов областей памяти,
<A HREF="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=mtrr&sektion=4&arch=i386  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=mtrr&sektion=4&arch=i386'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=mtrr&sektion=4&arch=i386">mtrr(4)</A>,
управляющих параметрами кэширования:

<PRE><STRONG>pseudo-device mtrr</STRONG></PRE>

<P>
Эти регистры используются X Window System и теоретически ускоряют работу
с видео подсистемой.

<P>
Второе псевдо-устройство предоставляет доступ к &quot;счетчикам
производительности&quot; процессоров Intel и к счетчикам времени TSC на других
процессорах,
<A HREF="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=pctr&sektion=4&arch=i386  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=pctr&sektion=4&arch=i386'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=pctr&sektion=4&arch=i386">pctr(4)</A>:

<PRE><STRONG>pseudo-device pctr</STRONG></PRE>

<P>
"Счетчики производительности" процессоров Intel поддерживают широкие
возможности по наблюдению за прерываниями, кэшированием и др., в то
время как счетчик времени содержит монотонно возрастающее 64-битное
значение, обнуляемое при включении процессора или при естественном
переполнении разрядной сетки.

<P>
Эти средства часто используются в программах, измеряющих скорость
работы каких-либо процессов. Просмотреть текущие значения счетчиков
и запрограммировать их можно с помощью утилиты
<A HREF="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=pctr&sektion=1&arch=i386  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=pctr&sektion=1&arch=i386'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=pctr&sektion=1&arch=i386">pctr(1)</A>.

<A NAME="debug"></A>
<H3>Опции, используемые при отладке</H3>

<P>
Отладка ядра OpenBSD может выполняться в двух режимах: непосредственно после
аварийного останова с использованием встроенного отладчика
<A HREF="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=ddb&sektion=4  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=ddb&sektion=4'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=ddb&sektion=4">ddb(4)</A>
или отладка дампа памяти ядра в
<A HREF="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=gdb&sektion=1  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=gdb&sektion=1'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=gdb&sektion=1">gdb(1)</A>
с использованием дополнительного ядра, содержащего отладочные символы.
Возможно использование обоих методов. За возможность использования
<span>ddb</span> отвечает опция <CODE><B>DDB</B></CODE>,
для того чтобы отлаживать ядро по дампу памяти, необходимо соблюдение
двух условий:

<UL>
<LI>размер swap вмещает полный дамп памяти с некоторым запасом;
<LI>ядро собрано с опцией <CODE><B>makeoptions DEBUG=&quot;-g&quot;</B></CODE>.
</UL>

<P>
Для отладки пользовательских процессов удобно использовать
<A HREF="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=ktrace&sektion=1  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=ktrace&sektion=1'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=ktrace&sektion=1">ktrace(1)</A>
или
<A HREF="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=gdb&sektion=1  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=gdb&sektion=1'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=gdb&sektion=1">gdb(1)</A>.
Для этого необходимо включить опции <CODE><B>KTRACE</B></CODE> и
<CODE><B>PTRACE</B></CODE> соответственно.

<P>
Важной является и опция <CODE><B>BOOT_CONFIG</B></CODE>, разрешающая
изменение параметров ядра на этапе загрузки через
<A HREF="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=boot_config&sektion=8&arch=i386  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=boot_config&sektion=8&arch=i386'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=boot_config&sektion=8&arch=i386">User Kernel Config (UKC)</A>.

<A NAME="diag"></A>
<H3>Статистика и диагностика</H3>

<P>
OpenBSD поддерживает ряд опций, связанных со сбором статистики и
дополнительными проверками в коде ядра:

<P>
<TABLE class="list" WIDTH="100%" CELLPADDING="10" CELLSPACING="0">
<TR VALIGN="top">
<TD WIDTH="20%">
  <CODE><B>ACCOUNTING</B></CODE>
</TD>
<TD>
  Поддержка сбора статистики работы системы по процессам (сюда входят данные
  по нагрузке на процессор, дисковую подсистему и так далее).
  Включение сбора статистики производится с помощью
  <A HREF="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=accton&sektion=8  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=accton&sektion=8'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=accton&sektion=8">accton(8)</A>.
</TD>
</TR>
<TR VALIGN="top">
<TD>
  <CODE><B>DIAGNOSTIC</B></CODE>
</TD>
<TD>
  Включить дополнительные проверки в коде. Обычно это незначительные проверки,
  которые могут привести к kernel panic. Можно попробовать отключить данную
  опцию для достижения большей надежности системы, однако это может привести и
  к нежелательным последствиям.
</TD>
<TR VALIGN="top">
<TD>
  <CODE><B>KMEMSTATS</B></CODE>
</TD>
<TD>
  Сбор статистики по использованию памяти. Может быть отключен, поскольку
  требует дополнительных затрат процессора и памяти.
</TD>
</TR>
</TABLE>

<P>
Для достижения повышенной скорости работы эти опции могут быть почти
безболезненно удалены из конфигурации ядра.

<A NAME="ip"></A>
<H3>Стеки протоколов IPv4 и IPv6</H3>

<P>
<TABLE class="list" WIDTH="100%" CELLPADDING="10" CELLSPACING="0">
<TR VALIGN="top">
<TD WIDTH="20%">
  <CODE><B>INET</B></CODE>
</TD>
<TD>
  Поддержка стека протоколов IPv4. Во многих случаях опция необходима.
</TD>
</TR>
<TR VALIGN="top">
<TD>
  <CODE><B>INET6</B></CODE>
</TD>
<TD>
  Поддержка стека протоколов IPv6. Требует IPv4. Если вы не работаете с IPv6,
  данную опцию можно отключить.
</TD>
</TR>
<TR VALIGN="top">
<TD>
  <CODE><B>TCP_SACK</B></CODE>
</TD>
<TD>
  Поддержка механизма выборочного подтверждения TCP сегментов (Selective
  Acknowledgements, RFC 2018). Позволяет повысить эффективность передачи TCP
  сегментов. TCP SACK должен поддерживаться сервером и клиентами.
</TD>
</TR>
<TR VALIGN="top">
<TD>
  <CODE><B>TCP_ECN</B></CODE>
</TD>
<TD>
  Поддержка явных уведомлений о перегрузках в сети (Explicit Congestion
  Notification, RFC 3168). Позволяет дополнительно регулировать скорость
  передачи TCP сегментов между двумя сторонами в следствии перегрузок в
  канале передачи. TCP ECN должен поддерживаться обоими сторонами.
</TD>
</TR>
<TR VALIGN="top">
<TD>
  <CODE><B>TCP_SIGNATURE</B></CODE>
</TD>
<TD>
  Поддержка подписи сегментов TCP с использованием MD5 хэш сумм
  (Protection of BGP Sessions via the TCP MD5 Signature Option, RFC 2385).
  Используется протоколом внешней маршрутизации BGP для установления
  подлиности отправителя. Возможность подписи сегментов TCP должна
  поддерживаться обоими сторонами. Требует наличия опции
<CODE><B>CRYPTO</B></CODE>.
</TD>
</TR>
<TR VALIGN="top">
<TD>
  <CODE><B>ALTQ</B></CODE>
</TD>
<TD>
  Поддержка механизмов обеспечения качества обслуживания (Quality of Service,
  QoS). Включает в себя ряд дисциплин трафика: приоритетную, классовую и
  иерархическую. Управление очередями осуществляется посредством соответствующих
  <A HREF="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=pf.conf&sektion=5  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=pf.conf&sektion=5#QUEUEING'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=pf.conf&sektion=5#QUEUEING">
  правил pf(4)</A>.
</TD>
</TR>
</TABLE>

<P>
Пакетный фильтр
<A HREF="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=pf&sektion=4  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=pf&sektion=4'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&sektion=4">pf(4)</A>,
работающий на межсетевом уровне (Internetworking) стека TCP/IP, поддерживает
работу как с IPv4, так и с IPv6 в зависимости от конфигурации ядра. Поддержка
<span>pf(4)</span> в ядре включается добавлением псевдо-устройства:

<PRE><STRONG>pseudo-device pf</STRONG></PRE>

<P>
Для того чтобы в
<A HREF="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=pf.conf&sektion=5  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=pf.conf&sektion=5'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=pf.conf&sektion=5">правилах pf(4)</A>
можно было использовать директиву <CODE><B>log</B></CODE>, необходимо добавить
поддержку псевдо-интерфейса
<A HREF="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=pflog&sektion=4  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=pflog&sektion=4'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=pflog&sektion=4">pflog(4)</A>:

<PRE><STRONG>pseudo-device pflog</STRONG></PRE>

<P>
Синхронизация таблицы состояний соединений (connection state table)
реализуется через интерфейс
<A HREF="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=pfsync&sektion=4  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=pfsync&sektion=4'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=pfsync&sektion=4">pfsync(4)</A>,
поддержка которого в ядре реализуется через псевдо-устройство:

<PRE><STRONG>pseudo-device pfsync</STRONG></PRE>

<P>
На основе
<A HREF="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=pfsync&sektion=4  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=pfsync&sektion=4'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=pfsync&sektion=4">pfsync(4)</A>,
построен протокол Common Address Redundancy Protocol (CARP), реализуемый в
OpenBSD через псевдо-устройство
<A HREF="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=carp&sektion=4  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=carp&sektion=4'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=carp&sektion=4">carp(4)</A>:

<PRE><STRONG>pseudo-device carp</STRONG></PRE>

<A NAME="crypto"></A>
<H3>Криптография в ядре. Использование криптографии в
сетевых протоколах</H3>

<P>
Криптография очень широко используется в ядре OpenBSD. В основу положено
обобщенное
<A HREF="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=crypto&sektion=9  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=crypto&sektion=9'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=crypto&sektion=9">OpenBSD 
Cryptographic Framework (OCF)</A>,
которое включается в сборку при указании опции <CODE><B>CRYPTO</B></CODE> -
это базис для всего кода, использующего криптографию в ядре.

<P>
Опция <CODE><B>UVM_SWAP_ENCRYPT</B></CODE> включает шифрование страниц
памяти до попадания в swap. По результатам тестирования на это затрачивается
сравнительно немного ресурсов, но для повышения быстродействия на слабых
машинах, возможно, имеет смысл исключить эту опцию из файла конфигурации ядра.
Отключить шифрование можно также через
<A HREF="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&sektion=8  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&sektion=8'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&sektion=8">sysctl(8)</A>:

<PRE><STRONG># sysctl vm.swapencrypt.enable=0</STRONG></PRE>

<P>
OpenBSD поддерживает ряд устройств, называемых крипто-акселераторами
(<A HREF="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=hifn&sektion=4  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=hifn&sektion=4'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=hifn&sektion=4">hifn(4)</A>,
<A HREF="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=ubsec&sektion=4  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=ubsec&sektion=4'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=ubsec&sektion=4">ubsec(4)</A>
и др.), которые способны регистрировать в OCF поддерживаемые алгоритмы, и ядро
в состоянии разгрузить работу по шифрованию на такие устройства. Доступ
пользовательских программ (таких как
<A HREF="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=openssl&sektion=1  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=openssl&sektion=1'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=openssl&sektion=1">OpenSSL</A>)
к этой подсистеме организуется через псевдо-устройство
<A HREF="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=crypto&sektion=4  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=crypto&sektion=4'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=crypto&sektion=4">crypto(4)</A>:

<PRE><STRONG>pseudo-device crypto</STRONG></PRE>

<P>
Практика показывает, что использование подобных устройств способно реально
повысить быстродействие только в определенных случаях. Узкими местами
являются пропускная способность шины PCI и медлительность самих устройств,
по сравнению с современными CPU. Крипто-акселераторы могут повысить
быстродействие в тех случаях, когда используются медленные CPU, шина PCI
разгружена, а также при больших блоках шифруемых данных и при определенных
алгоритмах шифрования (чаще всего - блочных симметричных шифрах, например 3DES).
Однако, весьма эффективными являются криптографические средства, встроенные
непосредственно в CPU. Ярким примером является процессор
<A HREF="javascript:if(confirm('http://www.via.com.tw/en/products/processors/eden-n/  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.via.com.tw/en/products/processors/eden-n/'" tppabs="http://www.via.com.tw/en/products/processors/eden-n/">VIA Eden-N</A>,
поддерживающий инструкции работы с блочным симметричным шифрованием AES.

<P>
Поддержка IPsec включается опцией <CODE><B>IPSEC</B></CODE>. Требуется
поддержка IPv4 стека (опция <CODE><B>INET</B></CODE>), OCF (опция
<CODE><B>CRYPTO</B></CODE>) и специализированного псевдо-интерфейса
<A HREF="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=enc&sektion=4  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=enc&sektion=4'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=enc&sektion=4">enc(4)</A>,
позволяющего фильтровать пакеты до и после их обработки кодом IPsec:

<PRE><STRONG>pseudo-device enc</STRONG></PRE>

<P>
Средства криптографии также применяются в ряде сетевых протоколов. При
использовании BGP маршрутизации очень часто используются подписанные TCP
сегменты для обеспечения аутентификации источника сообщений. В OpenBSD это
делается добавлением опции <CODE><B>TCP_SIGNATURE</B></CODE> (это требует
включенных опций <CODE><B>INET</B></CODE>, <CODE><B>CRYPTO</B></CODE>,
<CODE><B>IPSEC</B></CODE>).

<P>
Протоколы
<A HREF="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=pfsync&sektion=4  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=pfsync&sektion=4'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=pfsync&sektion=4">pfsync(4)</A>
и
<A HREF="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=carp&sektion=4  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=carp&sektion=4'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=carp&sektion=4">carp(4)</A>
также используют криптографическую подпись пакетов, поэтому нуждаются в
поддержке OCF и зависят от ряда компонент IPsec.

<A NAME="filesystem"></A>
<H3>Файловые системы</H3>

<P>
Основной файловой системой в OpenBSD является Berkeley Fast File System.
Также поддерживаются FAT, NTFS, Linux Extended 2, ISO-9660, UDF и две
сетевые файловые системы: NFS и XFS.

<P>
<TABLE class="list" WIDTH="100%" CELLPADDING="10" CELLSPACING="0">
<TR VALIGN="top">
<TD WIDTH="20%">
  <CODE><B>FFS,FFS2</B></CODE>
</TD>
<TD>
  Файловая система Berkeley Fast File System с поддержкой 2-ой версии.
</TD>
</TR>
<TR VALIGN="top">
<TD>
  <CODE><B>FFS_SOFTUPDATES</B></CODE>
</TD>
<TD>
  Поддержка SoftUpdates для FFS и FFS2. За счет системы буферизации заметно
  увеличивает скорость записи на диск.
</TD>
</TR>
<TR VALIGN="top">
<TD>
  <CODE><B>UFS_DIRHASH</B></CODE>
</TD>
<TD>
  Хеширование содержимого директорий, повышает скорость доступа к директориям
  с большим количеством файлов.
</TD>
</TR>
<TR VALIGN="top">
<TD>
  <CODE><B>QUOTA</B></CODE>
</TD>
<TD>
  Поддержка квот на файловых системах FFS и FFS2.
</TD>
</TR>
<TR VALIGN="top">
<TD>
<CODE><B>MFS</B></CODE>
</TD>
<TD>
  Поддержка создания файловой системы в оперативной памяти, способной к
  переходу в свап.
</TD>
</TR>
<TR VALIGN="top">
<TD>
  <CODE><B>MSDOSFS</B></CODE>
</TD>
<TD>
  Поддержка FAT12, FAT16 и FAT32.
</TD>
</TR>
<TR VALIGN="top">
<TD>
  <CODE><B>NTFS</B></CODE>
</TD>
<TD>
  Поддержка NTFS4 (Windows NT 4.0) и NTFS5 (Windows 2000 и более поздние) в
  режиме только для чтения.
</TD>
</TR>
<TR VALIGN="top">
<TD>
  <CODE><B>EXT2FS</B></CODE>
</TD>
<TD>
  Поддержка Linux Extended 2 File System (и Extended 3 без журналирования) с
  размером inode равным 128.  Для переформатирования следует использовать
  опцию <CODE>-I 128</CODE> команды <CODE>mkfs.ext2</CODE>.  Файловые системы
  ext3 рекомендуется монтировать <EM>только</EM> в режиме для чтения.
</TD>
</TR>
<TR VALIGN="top">
<TD>
  <CODE><B>CD9660</B></CODE>
</TD>
<TD>
  Поддержка файловой системы ISO-9660, используемой на CD и DVD дисках
  (мультисессионные диски не поддерживаются).
</TD>
</TR>
<TR VALIGN="top">
<TD>
  <CODE><B>UDF</B></CODE>
</TD>
<TD>
  Поддержка файловой системы DVD. Некоторые DVD диски могут быть смонтированы
  как обычные CD.
</TD>
</TR>
<TR VALIGN="top">
<TD>
  <CODE><B>NFSCLIENT</B></CODE><BR>
  <CODE><B>NFSSERVER</B></CODE>
</TD>
<TD>
Поддержка сетевой файловой системы NFS в режимах клиента и сервера.
</TD>
</TR>
<TR VALIGN="top">
<TD>
  <CODE><B>XFS</B></CODE>
</TD>
<TD>
  Поддержка сетевой распределенной файловой системы Andrew FS (AFS).
</TD>
</TR>
</TABLE>

<P>
Существуют и несколько виртуальных файловых систем: PROCFS и PORTAL.
Однако, из-за архитектурных особенностей системы они являются
необязательными. Файловая система PROCFS используется в основном с эмуляцией
Linux, а поддержка PORTAL осталась со времен BSD UNIX и не несет в себе
никакой смысловой нагрузки.

<A NAME="compat"></A>
<H3>Совместимость с ранними версиями</H3>

<P>
OpenBSD, как и любая развивающаяся система, эволюционирует, но в тоже
время пытается оставаться совместимой с прежними интерфейсами ядра и
двоичными файлами, скомпилированными для ранних версий системы.
Для этого существует ряд опций:

<P>
<TABLE class="list" WIDTH="100%" CELLPADDING="10" CELLSPACING="0">
<TR VALIGN="top">
<TD WIDTH="20%">
  <CODE><B>COMPAT_43</B></CODE>
</TD>
<TD>
  Самая старая из опций совместимости. Отвечает за поддержку ряда устаревших
  ioctl'ей для терминальных устройств и других незначительных интерфейсов.
  На практике опция нужна только при использовании опции COMPAT_BSDOS.
</TD>
</TR>
<TR VALIGN="top">
<TD>
  <CODE><B>COMPAT_O43</B></CODE>
</TD>
<TD>
  Опции совместимости с соответствующей версией OpenBSD. Они вводились, когда
  менялись интерфейсы ядра. Более подробно о том, для чего введены эти опции,
  написано в руководстве
<A HREF="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=options&sektion=4  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=options&sektion=4'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=options&sektion=4">options(4)</A>.
</TD>
</TR>
<TR VALIGN="top">
<TD> 
  <CODE><B>COMPAT_AOUT</B></CODE>
</TD>
<TD>
  Поддержка двоичных файлов, собранных для OpenBSD/i386 версий ниже 3.4 (т.е.
  двоичные файлы формата <EM>a.out</EM>). Возможно, будет необходимо также
  включить опции совместимости с предыдущими версиями OpenBSD. Эмуляция
  активизируется при включении опции <CODE><I>kern.emul.aout</I></CODE>.
</TD>
</TR>
</TABLE>

<A NAME="emul"></A>
<H3>Двоичная совместимость с другими системами</H3>

<P>
OpenBSD поддерживает эмуляцию системных вызовов для некоторых систем.
Основным требованием является принадлежность двоичного файла и хостовой
системе к одной архитектуре. Например, OpenBSD поддерживает исполняемые
файлы от Solaris, но программы, оттранслированные для архитектуры SPARC,
не загрузятся на i386-совместимом процессоре.

<P>
Подсистемы эмуляции опциональны и при желании могут не включаться в ядро.

<P>
Рассмотрим опции двоичной совместимости, предоставляемые для архитектуры i386.
По умолчанию эмуляция всех систем является отключенной. Для активизации
необходимо выставить соответствующий sysctl-флаг.

<P>
<TABLE class="list" WIDTH="100%" CELLPADDING="10" CELLSPACING="0">
<TR VALIGN="top">
<TD WIDTH="20%">
  <CODE><B>COMPAT_LINUX</B></CODE>
</TD>
<TD>
  Поддержка запускаемых файлов ОС Linux. (Возможно, придется так же установить
  порт с библиотеками Linux системы,
  <span>/usr/ports/emulators/redhat/</span>). Эмуляция
  активизируется при включении <CODE><I>kern.emul.linux</I></CODE>.
  Подробную информацию можно получить из
  <A HREF="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=compat_linux&sektion=8  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=compat_linux&sektion=8'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=compat_linux&sektion=8">страницы
  руководства</A>. 
</TD>
</TR>
<TR VALIGN="top">
<TD>
  <CODE><B>COMPAT_FREEBSD</B></CODE>
</TD>
<TD>
  Поддержка запускаемых файлов ОС FreeBSD. (Существует порт, содержащий
  библиотеки FreeBSD,
  <span>/usr/ports/emulators/freebsd_lib/</span>). Эмуляция
  активизируется при включении <CODE><I>kern.emul.freebsd</I></CODE>.
  Подробную информацию можно получить из
  <A HREF="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=compat_freebsd&sektion=8  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=compat_freebsd&sektion=8'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=compat_freebsd&sektion=8">страницы
  руководства</A>.
</TD>
</TR>
<TR VALIGN="top">
<TD>
  <CODE><B>COMPAT_BSDOS</B></CODE><BR>
  <CODE><B>COMPAT_IBCS2</B></CODE><BR>
  <CODE><B>COMPAT_SVR4</B></CODE>
</TD>
<TD>
  Поддержка запускаемых файлов систем BSDI, Solaris, SCO и др. Подробную
  информацию можно найти в руководствах:
  <A HREF="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=compat_bsdos&sektion=8  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=compat_bsdos&sektion=8'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=compat_bsdos&sektion=8">compat_bsdos(8)</A>,
  <A HREF="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=compat_ibcs2&sektion=8  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=compat_ibcs2&sektion=8'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=compat_ibcs2&sektion=8">compat_ibcs2(8)</A>,
  <A HREF="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=compat_svr4&sektion=8  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=compat_svr4&sektion=8'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=compat_svr4&sektion=8">compat_svr4(8)</A>.
</TD>
</TR>
</TABLE>

<P>
Если вы не используете двоичную совместимость с другими системами, настоятельно
рекомендуется не включать эмуляцию, поскольку история проекта уже насчитывает
ряд уязвимостей, выявленных в подсистеме эмуляции файлов iBCS2 и др.

<A NAME="xwindow"></A>
<H3>X Window System</H3>

Для корректной работы X Window System необходимы или желательны следующие
опции (платформа i386):

<P>
<TABLE class="list" WIDTH="100%" CELLPADDING="10" CELLSPACING="0">
<TR VALIGN="top">
<TD WIDTH="20%">
  <CODE><B>APERTURE</B></CODE>
</TD>
<TD>
  Драйвер апертуры ядра, позволяет X серверу получать прямой доступ к видео
  памяти и регистрам PCI устройств. Непосредственное разрешение использования
  апертуры ядра осуществляется через sysctl-переменную:
<CODE><I>machdep.allowaperture</I></CODE>.
</TD>
</TR>
<TR VALIGN="top">
<TD>
  <CODE><B>USER_PCICONF</B></CODE>
</TD>
<TD>
  Предоставляет прикладным процессам (например, X серверу) возможность получения
  доступа к конфигурации PCI устройств.
</TD>
</TR>
<TR VALIGN="top">
<TD>
  <CODE><B>WSDISPLAY_COMPAT_RAWKBD</B></CODE><BR>
  <CODE><B>WSDISPLAY_COMPAT_PCVT</B></CODE>
</TD>
<TD>
  Позволяет получить доступ к клавиатуре.
</TD>
</TR>
</TABLE>

<P>
На архитектуре i386 система X Window System может использовать регистры
атрибутов областей памяти,
<A HREF="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=mtrr&sektion=4&arch=i386  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=mtrr&sektion=4&arch=i386'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=mtrr&sektion=4&arch=i386">mtrr(4)</A>,
управляющих параметрами кэширования. Использование этого механизма теоретически
позволяет ускорить работу с видео подсистемой.

<P>
<HR>
<A HREF="index-1.html" tppabs="http://www.openbsd.ru/docs/index.html"><IMG HEIGHT="24" WIDTH="24" SRC="back.gif" tppabs="http://www.openbsd.ru/images/back.gif"
 ALT="OpenBSD.ru"></A>
<A HREF="mailto:www@openbsd.ru">www@openbsd.ru</A>
<BR>
<SMALL>$RuOBSD: howto-kernconf.html,v 1.43 2010/11/01 10:57:47 dinar Exp $</SMALL>

</BODY>
</HTML>
