<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=koi8-r">
<meta http-equiv="Content-Language" content="ru">
<meta name="copyright" content="Copyright (c) 2005 by OpenBSD.ru">
<title>Sendmail: Обеспечение антивирусной защиты с помощью Clamav</title>
<link rel="stylesheet" type="text/css" href="style.css" tppabs="http://www.openbsd.ru/style.css">
</head>

<body>

<h2>Sendmail: Обеспечение антивирусной защиты с помощью Clamav</h2>
<hr>

<h3>Мини-руководство "шаг за шагом"</h3>

<p>
<table border=0>
<tr><td>

<p>
Устанавливаем <tt>clamav</tt> из портов:

<pre>
# <strong>cd /usr/ports/security/clamav</strong>
# <strong>make install clean CLEANDEPENDS=Yes</strong>
</pre>

<p>
Или с помощью прекомпилированного пакета:

<pre>
# <strong>pkg_add ftp://ftp.openbsd.org/pub/OpenBSD/3.8/packages/i386/clamav-0.88.tgz</strong>
</pre>

<p>
Переходим в каталог с примерами конфигурационных mc-файлов:

<pre>
# <strong>cd /usr/share/sendmail/cf</strong>
</pre>

<p>
Подключаем антивирус:

<pre>
# <strong>vi server.mc</strong>

# Для взаимодействия с sendmail используем TCP-сокет.
#
INPUT_MAIL_FILTER(`clamav', `S=inet:3311@127.0.0.1, F=T, T=S:4m;R:4m')dnl

# Альтернативный вариант: используем доменный сокет Unix.
#
INPUT_MAIL_FILTER(`clamav', `S=local:/var/clamav/clamav-milter.sock, F=T, T=S:4m;R:4m')dnl

# `F=' позволяет разрешать прохождение почты в случае сбоя clamav-milter.
#
dnl INPUT_MAIL_FILTER(`clamav', `S=inet:3311@127.0.0.1, F=, T=S:4m;R:4m')dnl
dnl INPUT_MAIL_FILTER(`clamav', `S=local:/var/clamav/clamav-milter.sock, F=, T=S:4m;R:4m')dnl
</pre>

<p>
Пересобираем mc-файл, предварительно сделав копию исходного
<span>/etc/mail/sendmail.cf</span>:

<pre>
# <strong>cp /etc/mail/sendmail.cf /etc/mail/sendmail.cf.bak</strong>
# <strong>m4 ../m4/cf.m4 server.mc > /etc/mail/sendmail.cf</strong>
</pre>

<p>
Редактируем конфигурационный файл <tt>freshclam</tt>:

<pre>
# <strong>vi /etc/freshclam.conf</strong>
DatabaseDirectory /var/db/clamav
UpdateLogFile /var/clamav/freshclam.log
PidFile /var/clamav/freshclam.pid
DatabaseOwner _clamav
DatabaseMirror database.clamav.net
Checks 2
</pre>

<p>
Запускаем <tt>freshclam</tt> в режиме демона:

<pre>
# <strong>/usr/local/bin/freshclam -d</strong>
</pre>

<p>
Проверяем получение антивирусных баз:

<pre>
# <strong>ls -l /var/db/clamav</strong>
total 5344
-rw-r--r--  1 _clamav  _clamav   146241 Oct 25 23:36 daily.cvd
-rw-r--r--  1 _clamav  _clamav  2560365 Oct 25 23:36 main.cvd
</pre>

<p>
<span><b>Вариант 1</b></span>: используем TCP-сокет и отказываемся
от демона <tt>clamd</tt>:

<pre>
# <strong>/usr/local/sbin/clamav-milter -qlo -U /var/clamav/quarantine \
	-m 10 -T 0 inet:3311@127.0.0.1</strong>
</pre>

<p>
<span><b>Вариант 2</b></span>: взаимодействуем через Unix-сокет
и используем <tt>clamd</tt>:

<pre>
# <strong>vi /etc/clamd.conf</strong>
LogFile /var/clamav/clamd.log
PidFile /var/clamav/clamd.pid
TemporaryDirectory /var/tmp
DatabaseDirectory /var/db/clamav
LocalSocket /var/clamav/clamd.sock
FixStaleSocket
User _clamav
</pre>

<p>
Создаем лог-файл, чтобы <tt>clamd</tt> и <tt>clamav-milter</tt> могли
выполнять журналирование событий:

<pre>
# <strong>touch /var/clamav/clamd.log</strong>
# <strong>chown _clamav:_clamav /var/clamav/clamd.log</strong>
</pre>

<p>
Загружаем <tt>clamd</tt>:

<pre>
# <strong>/usr/local/sbin/clamd</strong>
</pre>

<p>
Загружаем <tt>clamav-milter</tt>:

<pre>
# <strong>/usr/local/sbin/clamav-milter -loP -U /var/clamav/quarantine \
	--pidfile=/var/clamav/clamav-milter.pid \
	--external local:/var/clamav/clamav-milter.sock</strong>
</pre>

<p>
Вне зависимости от выбранного варианта запускаем <tt>sendmail</tt>:

<pre>
# <strong>/usr/sbin/sendmail -L sm-mta -bd -q30m</strong>
</pre>

<p>
Либо заставляем демона перечитать свой cf-конфиг:

<pre>
# <strong>kill -HUP `head -1 /var/run/sendmail.pid`</strong>
</pre>

<p>
В первом случае в <span>/etc/rc.local</span> прописываем
автозапуск <tt>freshclam</tt> и <tt>clamav-milter</tt>:

<pre>
# <strong>vi /etc/rc.local</strong>
if [ -x /usr/local/bin/freshclam ]; then
	echo -n ' freshclam'; /usr/local/bin/freshclam -d
fi

if [ -x /usr/local/sbin/clamav-milter ]; then
	echo -n ' clamav-milter'
	/usr/local/sbin/clamav-milter -qlo -U /var/clamav/quarantine \
		-m 10 -T 0 inet:3311@127.0.0.1
fi
</pre>

<p>
При использовании второго варианта:

<pre>
# <strong>vi /etc/rc.local</strong>
if [ -f /etc/clamd.conf -a -f /etc/freshclam.conf ]; then

	rm -f /var/clamav/*.pid /var/clamav/*.sock

	if [ -x /usr/local/bin/freshclam ]; then
		echo -n ' freshclam'; /usr/local/bin/freshclam -d
	fi

	if [ -x /usr/local/sbin/clamd ]; then
		echo -n ' clamd'; /usr/local/sbin/clamd
	fi

	if [ -x /usr/local/sbin/clamav-milter ]; then
		echo -n ' clamav-milter'
			sleep 2
			/usr/local/sbin/clamav-milter \
			-loP -U /var/clamav/quarantine \
			--pidfile=/var/clamav/clamav-milter.pid \
			--external local:/var/clamav/clamav-milter.sock
	fi

fi
</pre>

<p>
Начиная с версии 0.90.х, может потребоваться изменить стартовый сценарий
так, чтобы clamav-milter смог корректно запуститься после того, как clamd
загрузит свою вирусную базу.

<pre>
# <strong>vi /etc/rc.local</strong>
if [ -f /etc/clamd.conf -a -f /etc/freshclam.conf ]; then
	rm -f /var/clamav/*.pid /var/clamav/*.sock

	if [ -x /usr/local/bin/freshclam ]; then
		echo -n ' freshclam'; /usr/local/bin/freshclam -d
	fi

	sleep 2

	if [ -x /usr/local/sbin/clamd ]; then
		echo -n ' clamd'; /usr/local/sbin/clamd
	fi

	if [ -x /usr/local/sbin/clamav-milter ]; then
		echo -n ' clamav-milter'

		retry=20
		while [ ! -f /var/clamav/clamd.sock -a ! $retry = 0 ]; do
			sleep 1
			retry=$(($retry - 1))
		done

		/usr/local/sbin/clamav-milter -eql -U /var/clamav/quarantine \
			inet:3311@127.0.0.1
	fi
fi
</pre>

</td></tr>
</table>

<p>
<hr>
<a href="javascript:if(confirm('http://www.openbsd.ru/docs/steps/index.html  \n\nThis file was not retrieved by Teleport Ultra, because it is linked too far away from its Starting Address. If you increase the in-domain depth setting for the Starting Address, this file will be queued for retrieval.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.ru/docs/steps/index.html'" tppabs="http://www.openbsd.ru/docs/steps/index.html"><img height=24 width=24 src="back.gif" tppabs="http://www.openbsd.ru/images/back.gif" alt="OpenBSD.ru"></a>
<a href="mailto:www@openbsd.ru">www@openbsd.ru</a>
<br>
<small>$RuOBSD: clamav.html,v 1.19 2010/11/01 10:57:48 dinar Exp $</small>

</body>
</html>
