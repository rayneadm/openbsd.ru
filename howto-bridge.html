<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=koi8-r">
<meta http-equiv="Content-Language" content="ru">
<meta name="copyright" content="Copyright (c) 2000-2005 by OpenBSD.ru">
<title>Настройка Ethernet Bridge</title>
<link rel="stylesheet" type="text/css" href="style.css" tppabs="http://www.openbsd.ru/style.css" />
</head>

<body>

<h2>Настройка Ethernet Bridge</h2>
<hr>

Использование Ethernet Bridge позволяет объединить несколько сегментов
Ethernet в один логический сегмент. При этом допустимо использование
правил фильтрации pf, что позволяет превратить OpenBSD в прозрачный IP
фильтр.

<p>
Чтобы настроить OpenBSD в качестве Ethernet Bridge, нужно
выполнить следующие шаги:
<ol>
  <li>Сконфигурировать ядро OpenBSD, включив в него псевдоустройство
  &quot;bridge&quot;. Файл конфигурации ядра должен содержать строку
  &quot;<strong>pseudo-device bridge</strong>&quot;.
  <li>Создать файл конфигурации <code>/etc/bridgename.bridge0</code>,
  содержащий команды конфигурации Bridge, например:
<pre>
	add rl0
	add fxp0
	up
</pre>
  В данном случае мы объявляем интерфейсы fxp0 и rl0 одним логическим
  Ethernet сегментом. Подробнее о командах конфигурирования Bridge
  можно прочитать в <a href="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=brconfig&sektion=8  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=brconfig&sektion=8'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=brconfig&sektion=8">brconfig(8)</a>.
  При использовании нескольких логических сегментов следует создать
  файл конфигурации для каждого псевдоустройства bridge.
  <p>
  <li>Создать файлы конфигурации сетевых интерфейсов:<br>
  <p><code>/etc/hostname.fxp0</code>:
<pre>
	inet 194.226.170.3 255.255.255.0 NONE
</pre>
  <p><code>/etc/hostname.rl0</code>:
<pre>
	up
</pre>
  Подробнее о файлах конфигурации сетевых интерфейсов можно прочитать в
  <a href="javascript:if(confirm('http://www.openbsd.org/cgi-bin/man.cgi?query=hostname.if&sektion=5  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?'))window.location='http://www.openbsd.org/cgi-bin/man.cgi?query=hostname.if&sektion=5'" tppabs="http://www.openbsd.org/cgi-bin/man.cgi?query=hostname.if&sektion=5">hostname.if(5)</a>
  <p>
  Обратите внимание, что в данном случае IP адрес присваивается только одному
  интерфейсу. Допускается также создание Bridge, не имеющего своего IP адреса.
  <p>
  <li>Перезагрузить машину.
</ol>

<p>
Ethernet Bridge также позволяет с помощью протокола Ethernet-over-IP
объединить в один логический сегмент сети, физически находящиеся далеко
друг от друга. Рассмотрим следующий пример:

<p>
<ul>
  <li>Хост <strong>A</strong>, адрес 81.1.212.10,
    внутренний интерфейс <strong>em0</strong>
  <li>Хост <strong>B</strong>, адрес 81.1.226.48,
    внутренний интерфейс <strong>rl0</strong>
</ul>

Чтобы объединить сегменты интерфейса <strong>em0</strong> хоста
<strong>A</strong> и <strong>rl0</strong> хоста <strong>B</strong>
в один логический Ethernet сегмент, нужно подать следующие команды:

<p>
Для хоста <strong>A</strong>:
<pre>
	# sysctl -w net.inet.etherip.allow=1
	# ifconfig gif0 tunnel 81.1.212.10 81.1.226.48
	# ifconfig bridge0 create
	# brconfig bridge0 add em0 add gif0 up
</pre>

<p>
Для хоста <strong>B</strong>:
<pre>
	# sysctl -w net.inet.etherip.allow=1
	# ifconfig gif0 tunnel 81.1.226.48 81.1.212.10
	# ifconfig bridge0 create
	# brconfig bridge0 add rl0 add gif0 up
</pre>

<h3>Замечания</h3>

<ul>
  <li>При использовании OpenBSD Packet Filter пакет, проходящий через
  Bridge, попадает под проверку PF два раза: при входе на одном интерфейсе
  и при выходе на другом. Чтобы производить keep-state фильтрацию, нам
  необходимо разрешить все входящие и исходящие пакеты на одном
  интерфейсе, а на другом производить фильтрацию. Пример правил:
<pre>
	# фильтрация производится на rl0, поэтому пропускаем все пакеты на rl1
	pass quick on rl1

	# по умолчанию мы блокируем все пакеты и пропускаем только
	# icmp запросы с получившимися keep-state ответами в обе стороны.
	block on rl0
	pass on rl0 inet proto icmp icmp-type echoreq code 0 keep state
</pre>
  <li>При использовании pf для фильтрации пакетов, проходящих через
  Bridge, действуют только правила для входящих пакетов.
  <li>Если во время работы Bridge производится перенос какого-нибудь
  компьютера (или другого устройства, имеющего свой Ethernet адрес) с
  одного Ethernet сегмента на другой, следует выполнить команду
<pre>
	# <strong>brconfig bridge0 flush</strong>
</pre>
  (где bridge0 - псевдоинтерфейс Bridge, к которому относится Ethernet
  сегмент, где раньше находился компьютер).
</ul>

<p>
Смотрите также по данной теме пошаговое <A HREF="bridge.html" tppabs="http://www.openbsd.ru/docs/steps/bridge.html">
руководство</A>, в котором рассматривается привязка IP к MAC с помощью bridge
и pf.

<p>
<hr>
<a href="index-1.html" tppabs="http://www.openbsd.ru/docs/index.html"><img height=24 width=24 src="back.gif" tppabs="http://www.openbsd.ru/images/back.gif" alt="OpenBSD.ru"></a>
<a href="mailto:www@openbsd.ru">www@openbsd.ru</a><br>
<small>$RuOBSD: howto-bridge.html,v 1.25 2010/11/01 10:57:47 dinar Exp $</small>

</body>
</html>
