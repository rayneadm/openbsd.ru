<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=koi8-r">
<meta http-equiv="Content-Language" content="ru">
<meta name="copyright" content="Copyright (c) 2005-2006 by OpenBSD.ru">
<title>OpenBSD: Аутентификационный шлюз на базе authpf</title>
<link rel="stylesheet" type="text/css" href="../../style.css" />
</head>

<body>

<h2>OpenBSD: Аутентификационный шлюз на базе authpf(8)</h2>
<hr>

<h3>Мини-руководство "шаг за шагом"</h3>

<p>
<table border=0>
<tr><td>

<p>
Усложняем проведение сетевых атак типа ARP- и IP-spoofing:

<pre>
# <strong>vi /etc/ssh/sshd_config</strong>
Protocol 2
ClientAliveInterval 15
ClientAliveCountMax 3
</pre>

<p>
После внесения изменений даем указание демону перечитать свой конфиг:

<pre>
# <strong>kill -HUP `head -1 /var/run/sshd.pid`</strong>
</pre>

<p>
В конец файла
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=login.conf&amp;sektion=5">
login.conf(5)</a> заносим сведения о новом классе authpf:

<pre>
# <strong>vi /etc/login.conf</strong>
authpf:\
	:shell=/usr/sbin/authpf:\
	:tc=default:
</pre>

<p>
Обновляем хэшированную базу данных <span>/etc/login.conf.db</span>:

<pre>
# <strong>cap_mkdb /etc/login.conf</strong>
</pre>

<p>
Так как будем использовать дефолтные значения директив anchor и table,
оставляем <span>/etc/authpf/authpf.conf</span> пустым:

<pre>
# <strong>echo -n &gt; /etc/authpf/authpf.conf</strong>
</pre>

<p>
Подготавливаем приветственное сообщение, аналог <span>/etc/motd</span>:

<pre>
# <strong>echo 'Please play nice.' &gt; /etc/authpf/authpf.message</strong>
</pre>

<p>
Создаем нового пользователя, который принадлежит классу authpf, входит в
группу authpf и в качестве оболочки получает <tt>/usr/sbin/authpf</tt>:

<pre>
# <strong>useradd -m -c 'authpf nat user' -g authpf -L authpf -s /usr/sbin/authpf andrey</strong>
# <strong>passwd andrey</strong>
</pre>

<p>
Создаем набор правил файервола для пользователя andrey:

<pre>
# <strong>mkdir -p /etc/authpf/users/andrey</strong>
# <strong>vi /etc/authpf/users/andrey/authpf.rules</strong>
ext_if = "fxp0"

nat on $ext_if inet from $user_ip to any -&gt; ($ext_if)
</pre>

<p>
Рассмотрим еще один пример. Допустим, нам &quot;извне&quot;нужно получить
доступ к серверу терминалов, расположенному за шлюзом. Создаем нового
пользователя rdp и определяем для него специальный набор правил файервола:

<pre>
# <strong>useradd -m -c 'authpf rdp user' -g authpf -L authpf -s /usr/sbin/authpf rdp</strong>
# <strong>passwd rdp</strong>
# <strong>mkdir -p /etc/authpf/users/rdp</strong>
# <strong>vi /etc/authpf/users/rdp/authpf.rules</strong>
ext_if = "fxp0"
rdp_server = "192.168.1.3"

rdr pass on $ext_if inet proto tcp from $user_ip to port 3389 \
	-&gt; $rdp_server port 3389
</pre>

<p>
Вносим необходимые изменения в <span>/etc/pf.conf</span>:

<pre>
# <strong>vi /etc/pf.conf</strong>
nat-anchor "authpf/*"
rdr-anchor "authpf/*"
#binat-anchor "authpf/*"
anchor "authpf/*"
</pre>

<p>
Перезагружаем набор рулесетов файервола:

<pre>
# <strong>pfctl -f /etc/pf.conf</strong>
</pre>

<p>
Чтобы получить доступ в интернет с любого клиентского компьютера из подсети
192.168.1.0/24, пользователь andrey сначала должен аутентифицироваться на
шлюзе:

<pre>
c:\putty&gt; <strong>plink.exe -pw secret andrey@192.168.1.1</strong>
Hello andrey. You are authenticated from host "192.168.1.2"
Please play nice.
</pre>

<p>
Для получения доступа &quot;извне&quot; к серверу терминалов вводим следующую
команду:

<pre>
c:\putty&gt; <strong>plink.exe -pw secret rdp@85.140.23.36</strong>
Hello rdp. You are authenticated from host "81.211.12.32"
Please play nice.
</pre>

<p>
Теперь порт 3389/tcp для IP-адреса 81.211.12.32 открыт, можно запускать
TS Client:

<pre>
c:\putty&gt; <strong>mstsc.exe /v:85.140.23.36:3389</strong>
</pre>

</td></tr>
</table>

<p>
<hr>
<a href="index.html"><img height=24 width=24 src="../../images/back.gif" alt="OpenBSD.ru"></a>
<a href="mailto:www@openbsd.ru">www@openbsd.ru</a>
<br>
<small>$RuOBSD: authpf.html,v 1.13 2010/11/01 10:57:48 dinar Exp $</small>

</body>
</html>
