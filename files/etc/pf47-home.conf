# $RuOBSD: pf47-home.conf,v 1.1 2010/07/04 20:20:51 form Exp $
#
# Пример настройки PF для простого маршрутизатора в домашней сети с реальным
# IP адресом, являющегося также почтовым сервером, сервером имен, WWW и FTP
# сервером, с трансляцией адресов и переадресацией некоторых TCP сервисов
# на внутренний сервер.
#
# В данном примере подразумевается, что скорость доступа в интернет 4Mbps,
# а скорость доступа к локальным ресурсам провайдера 100Mbps.
#
#   WAN              LAN
#    |     +--------------+---------
#    |     |              |
# +-fxp0--sis0-+  +----------------+
# |            |  |  10.10.10.194  |
# +------------+  +----------------+
#
# Файлы:
#       /etc/mail/spamd.bypass
#               - список адресов/сетей которые требуется пропускать к
#                 почтовому серверу без проверки
#	/etc/pf.local
#		- список локальных сетей провайдера


# Внешний и внутренний интерфейсы.
#
ext_if	= "fxp0"
int_if	= "sis0"

# Обслуживаемые сервисы.
#
tcp_svc	= "ftp ssh telnet domain www smtps imaps"
udp_svc	= "domain"

# TCP сервисы, обслуживаемые внутренним сервером.
#
e11_svc	= "telnet"
e11_hst	= "10.10.10.194"


# Не фильтровать loopback трафик.
#
set skip on lo


# Настройка очередей:
#  86 Mbit/s	- локальная сеть провайдера
#   3 Mbit/s	- обычный интернет трафик
#   1 Mbit/s	- высокоприоритетный трафик (TCP ACK, DNS, Telnet, HECnet)
#
altq on $ext_if hfsc bandwidth 90Mb queue { lan wan }
queue lan bandwidth 86Mb priority 1 hfsc
queue wan bandwidth 4Mb hfsc { def pri }
queue def bandwidth 75% priority 1 hfsc (default)
queue pri bandwidth 25% priority 7 hfsc (realtime 20%)


# По умолчанию заблокировать все.
# Возвращать RST для TCP соединений.
#
block
block return inet proto tcp

# Заблокировать IP адреса из черного списка.
# Запретить роутинг из внешней сети.
# Запретить IP спуфинг.
#
table <blocked> persist
block in quick on $ext_if from <blocked>
block in quick on $ext_if to !($ext_if)
block in quick on !$int_if from ($int_if:network)

# Раскидать пакеты по очередям.
#
table <local> file "/etc/pf.local"
match on $ext_if proto tcp queue (def pri)
match on $ext_if proto udp to port { domain 4711 } queue pri
match on $ext_if proto tcp to port telnet queue pri
match on $ext_if user named queue pri
match in on $ext_if from <local> queue lan
match out on $ext_if to <local> queue lan

# Подключить правила ftp-proxy.
#
anchor "ftp-proxy/*"
pass in quick on $int_if inet proto tcp to !(self) port ftp \
	rdr-to 127.0.0.1 port 8021

# Разрешить исходящий трафик.
# Включить NAT.
#
pass out inet
pass out on $ext_if inet from !($ext_if) nat-to ($ext_if:0)

# Разрешить входящий трафик на внутреннем интерфейсе.
# Запретить использование внешних SMTP серверов.
# Заблокировать возможную рассылку спама.
#
table <spammers> persist
pass in on $int_if from ($int_if:network)
block in on $int_if proto tcp to port smtp
block in quick on $int_if inet proto tcp from <spammers> to port smtp
pass in on $int_if inet proto tcp to (self) port smtp \
	keep state (max-src-conn-rate 5/10 overload <spammers> flush)

# Разрешить ICMP пинги и TCP/UDP сервисы.
#
pass in on $ext_if inet proto icmp to ($ext_if) icmp-type echoreq code 0
pass in on $ext_if inet proto tcp to ($ext_if) port { $tcp_svc }
pass in on $ext_if inet proto udp to ($ext_if) port { $udp_svc }

# Разрешить активные ftp соединения, инициированные с маршрутизатора
# и прочие сервисы с заранее не заданным номером порта.
#
pass in on $ext_if inet proto tcp to ($ext_if) port > 49151 user >= 0

# Включить greylisting.
# Пропустить напрямую адреса из белых списков.
# Обновлять timestamp для пакетов из белого списка.
#
table <spamd-white> persist
table <spamd-bypass> persist file "/etc/mail/spamd.bypass"
pass in on $ext_if inet proto tcp to ($ext_if) port smtp \
	rdr-to 127.0.0.1 port spamd
pass in on $ext_if inet proto tcp from <spamd-bypass> to ($ext_if) port smtp
pass in log on $ext_if inet proto tcp from <spamd-white> to ($ext_if) port smtp
pass out log on $ext_if inet proto tcp to <spamd-white> port smtp

# Переадресовать Ersatz-11 сервисы на E11 сервер.
#
pass in quick on $ext_if inet proto tcp to ($ext_if) port { $e11_svc } \
	rdr-to $e11_hst
